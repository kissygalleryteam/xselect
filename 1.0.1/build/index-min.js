KISSY.add('kg/xselect/1.0.0/index',["node","node","base","xtemplate"],function(S ,require, exports, module) {var e=require("node").one,t=require("node").all,o=require("base"),n=require("xtemplate"),l=e(document),s=e("html"),i=e(window),r=o.extend({initializer:function(){var e=this;e._renderUI(),e._bindUI(),e.fire("afterRenderUI"),e.sync(),e._resizeFix()},_renderUI:function(){var t,o,n=this,l=n.get("el");return t=e('<div class="xselect-drop"></div>').html(r.DROP_TMPL.render()),o=e('<div class="xselect-popup"></div>').html(r.POPUP_TMPL.render({addForm:n.get("addForm")})),t.insertAfter(l),o.appendTo("body"),n.set("elDrop",t),n.set("elPopup",o),n},_bindUI:function(){var t=this,o=t.get("el"),n=t.get("elDrop"),i=t.get("elPopup");return o.on("change",function(){t.select(o[0].selectedIndex)}),n.on("mouseenter",function(){t.set("active",!0)}).on("mouseleave",function(){t.set("active",!1)}).on("click",function(e){t.fire("click",e),t.toggle()}).insertAfter(o),i.on("mouseenter",function(){t.set("active",!0),s.css("overflow","hidden"),t.set("pos",t.get("elDrop").offset())}).on("mouseleave",function(){t.set("active",!1),s.css("overflow",""),t.set("pos",t.get("elDrop").offset())}).delegate("click",".xselect-option",function(o){o.halt(),t.select(e(o.currentTarget).attr("data-index"),!0)}).appendTo("body"),l.on("click",function(){t.get("active")||t.close()}),t._bindAddForm(),t._resizeFix(),t},_bindAddForm:function(){var o=this,n=o.get("elPopup");if(o.get("addForm")){var l,s,i,r,d="placeholder"in document.createElement("input");r=t(".xselect-addoption",n),l=t(".xselect-addoption-ipt",r),i=t(".xselect-addoption-btn",r);var a,c;a=function(e){i.removeClass("xselect-addoption-btn-disabled"),e&&(l.val(""),i.addClass("xselect-addoption-btn-disabled"))},c=function(){i.addClass("xselect-addoption-btn-disabled")},d||(s=e('<label for="xselect_ipt" class="xselect-addoption-ipt-placeholder">'+o.get("addForm").placeholder+"</label>"),s.insertAfter(l),l.on("valuechange",function(e){""!=e.newVal?s.hide():s.show()})),l.on("valuechange",function(e){var t=S.trim(e.newVal);t?i.removeClass("xselect-addoption-btn-disabled"):i.addClass("xselect-addoption-btn-disabled")}),r.on("submit",function(e){e.preventDefault(),i.hasClass("xselect-addoption-btn-disabled")||o.get("addForm").onSubmit.call(o,l.val(),a,c)})}return o},_resizeFix:function(){var e=this,t=null;return i.on("resize",function(){t&&clearTimeout(t),t=setTimeout(function(){e.set("size",{width:e.get("elDrop").outerWidth(),height:e.get("elDrop").innerHeight()}),e.set("pos",e.get("elDrop").offset())},250)}),e},_syncUI:function(){var e=this,o=t(".xselect-list",e.get("elPopup")),n=t(".xselect-title",e.get("elDrop")),l=e.get("options"),s=e.get("selectedIndex"),i=S.filter(l,function(e,t){return t==s})[0];return o.html(r.OPTION_TMPL.render({selectedIndex:s,options:l})),n.html(i.text),e.fire("afterSyncUI"),e},sync:function(){for(var e=this,t=e.get("el")[0],o=t.options,n=[],l=0,s=o.length;s>l;l+=1)n.push({text:o[l].text,value:o[l].value,as_placeholder:!o[l].value});return e.set("options",n),e.set("selectedIndex",t.selectedIndex),e._syncUI(),e},toggle:function(){var e=this,t=e.get("opened");return t?e.close():e.open(),e},open:function(){var e=this,t=e.get("elPopup"),o=e.get("elDrop"),n=e.get("pos"),l=e.get("size");return o.addClass("xselect-drop-focus"),t.css({left:n.left,top:n.top+l.height+1,width:l.width-2}).addClass("xselect-popup-focus"),e.set("opened",!0),e.fire("open"),e},close:function(){var e=this,t=e.get("elPopup"),o=e.get("elDrop");return o.removeClass("xselect-drop-focus"),t.css({left:-999999,top:-999999}).removeClass("xselect-popup-focus"),e.set("opened",!1),e.fire("close"),e},select:function(o,n){var l=this,s=l.get("el")[0];return o=parseInt(o,10),t("option",s).attr("selected",!1),e(s.options[o]).attr("selected",!0),l.sync(),l.fire("change",{selectedIndex:o}),n&&l.close(),l},add:function(o,n,l){var s=this,i=s.get("el"),r=s.get("elPopup"),d=t(".xselect-list",r),a=t(".xselect-options",r),c='<option value="'+n+'"'+(l?' selected="selected"':"")+">"+o+"</option>";return l&&t("option",i).attr("selected",!1),i.append(e(c)),s.sync(),a.scrollTop(d.height()),s},batchAdd:function(o,n){var l=this,s=l.get("el");n&&t("option",s).attr("selected",!1);for(var i=0,r=o.length;r>i;i+=1){var d=o[i],a='<option value="'+d.value+'"'+(d.selected?' selected="selected"':"")+">"+d.text+"</option>";s.append(e(a))}return l.sync(),l}},{name:"xSelect",ATTRS:{el:{value:null,setter:function(t){return t=e(t),t.hide(),t}},elDrop:{value:null},elPopup:{value:null},pos:{value:null,getter:function(e){return e||(e=this.get("elDrop").offset()),e},setter:function(e){var t=e,o=this.get("size"),n=this.get("elPopup");this.get("opened")&&n.css({left:t.left,top:t.top+o.height+1,width:o.width-2})}},size:{value:null,getter:function(e){return e||(e={width:this.get("elDrop").outerWidth(),height:this.get("elDrop").innerHeight()}),e}},options:{value:null},selectedIndex:{value:-1},opened:{value:!1},active:{value:!1},error:{value:!1,setter:function(e){1==e?(this.get("elDrop").addClass("xselect-drop-error"),this.get("elPopup").addClass("xselect-popup-error")):(this.get("elDrop").removeClass("xselect-drop-error"),this.get("elPopup").removeClass("xselect-popup-error"))}},addForm:{value:!1,getter:function(e){return e&&(e.placeholder=e.placeholder||"请输入...",e.maxlength=Math.max(e.maxlength,0),e.onSubmit=e.onSubmit||function(){}),e}}},DROP_TMPL:new n('<span class="xselect-title">请选择</span><i class="xselect-drop-icon"></i>'),POPUP_TMPL:new n('<div class="xselect-options"><ul class="xselect-list"></ul></div>{{#if addForm}}<form class="xselect-addoption"><input id="xselect_ipt" class="xselect-addoption-ipt" placeholder="{{addForm.placeholder}}" {{#if addForm.maxlength}}maxlength="{{addForm.maxlength}}"{{/if}}><button type="submit" class="xselect-addoption-btn xselect-addoption-btn-disabled">确定</button></form>{{/if}}'),OPTION_TMPL:new n('{{#each options}}{{^if as_placeholder}}<li><a class="xselect-option {{#if xindex===selectedIndex}}xselect-option-selected{{/if}}" data-index="{{xindex}}" href="javascript:void(0);" title="{{text}}">{{text}}</a></li>{{/if}}{{/each}}')});module.exports=r;});